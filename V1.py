import streamlit as st
from openai import OpenAI
import os
import importlib.util
import json
import logging
from typing import Tuple, Dict, Any

# Configuration du logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Configuration du client OpenAI
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))

def load_py_module(file_path: str, module_name: str):
    try:
        spec = importlib.util.spec_from_file_location(module_name, file_path)
        module = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(module)
        return module
    except Exception as e:
        logger.error(f"Erreur lors du chargement du module {module_name}: {e}")
        return None

# Chargement des modules
prestations = load_py_module('./prestations-heures.py', 'prestations_heures').get_prestations()
tarifs = load_py_module('./tarifs-prestations.py', 'tarifs_prestations').get_tarifs()
instructions = load_py_module('./chatbot-instructions.py', 'consignes_chatbot').get_chatbot_instructions()

def analyze_question(question: str, client_type: str, urgency: str) -> Tuple[str, str]:
    options = [f"{domaine}: {', '.join(prestations_domaine.keys())}" for domaine, prestations_domaine in prestations.items()]
    prompt = f"""Analysez la question suivante et identifiez le domaine juridique et la prestation la plus pertinente.

Question : {question}
Type de client : {client_type}
Degr√© d'urgence : {urgency}

Options de domaines et prestations :
{' '.join(options)}

R√©pondez avec le domaine et la prestation la plus pertinente, s√©par√©s par une virgule."""

    response = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": instructions},
            {"role": "user", "content": prompt}
        ]
    )
    
    answer = response.choices[0].message.content.strip()
    return answer.split(',', 1) if ',' in answer else (answer, "prestation g√©n√©rale")

def calculate_estimate(domaine: str, prestation: str, urgency: str) -> Tuple[int, int, list, Dict[str, Any]]:
    try:
        heures = prestations.get(domaine, {}).get(prestation, 10)
        tarif_horaire = tarifs.get("tarif_horaire_standard", 0)
        estimation = heures * tarif_horaire

        calcul_details = [
            f"Heures estim√©es: {heures}",
            f"Tarif horaire standard: {tarif_horaire} ‚Ç¨",
            f"Estimation initiale: {heures} x {tarif_horaire} = {estimation} ‚Ç¨"
        ]

        if urgency == "Urgent":
            facteur_urgence = tarifs.get("facteur_urgence", 1.5)
            estimation *= facteur_urgence
            calcul_details.extend([
                f"Facteur d'urgence appliqu√©: x{facteur_urgence}",
                f"Estimation apr√®s urgence: {estimation} ‚Ç¨"
            ])

        forfait = tarifs.get("forfaits", {}).get(prestation)
        if forfait:
            calcul_details.append(f"Forfait disponible: {forfait} ‚Ç¨")
            if forfait < estimation:
                estimation = forfait
                calcul_details.append(f"Forfait appliqu√©: {forfait} ‚Ç¨")

        estimation_basse, estimation_haute = round(estimation * 0.8), round(estimation * 1.2)
        calcul_details.append(f"Fourchette d'estimation: {estimation_basse} ‚Ç¨ - {estimation_haute} ‚Ç¨")

        tarifs_utilises = {
            "tarif_horaire_standard": tarif_horaire,
            "facteur_urgence": tarifs.get("facteur_urgence") if urgency == "Urgent" else "Non appliqu√©",
            "forfait_prestation": forfait if forfait else "Pas de forfait"
        }

        return estimation_basse, estimation_haute, calcul_details, tarifs_utilises
    except Exception as e:
        logger.exception(f"Erreur dans calculate_estimate: {str(e)}")
        raise

def get_detailed_analysis(question: str, client_type: str, urgency: str, domaine: str, prestation: str) -> Tuple[str, Dict[str, Any], str]:
    prompt = f"""Analysez la question suivante et expliquez votre raisonnement pour le choix du domaine juridique et de la prestation.

Question : {question}
Type de client : {client_type}
Degr√© d'urgence : {urgency}
Domaine recommand√© : {domaine}
Prestation recommand√©e : {prestation}

Structurez votre r√©ponse en trois parties :
1. Analyse d√©taill√©e
2. √âl√©ments sp√©cifiques utilis√©s (JSON)
3. Sources d'information"""

    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "Vous √™tes un assistant juridique expert."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.5,
            max_tokens=1000
        )

        parts = response.choices[0].message.content.strip().split('\n\n', 2)
        analysis = parts[0] if parts else "Analyse non disponible."
        elements_used = json.loads(parts[1]) if len(parts) > 1 else {}
        sources = parts[2] if len(parts) > 2 else "Aucune source sp√©cifique mentionn√©e."

        return analysis, elements_used, sources
    except Exception as e:
        logger.exception(f"Erreur lors de l'analyse d√©taill√©e : {e}")
        return "Une erreur s'est produite lors de l'analyse.", {"error": str(e)}, "Non disponible en raison d'une erreur."

def main():
    st.set_page_config(page_title="View Avocats - Devis en ligne", page_icon="‚öñÔ∏è", layout="wide")
    st.title("üèõÔ∏è View Avocats - Estimateur de devis")

    client_type = st.selectbox("Vous √™tes :", ("Particulier", "Professionnel", "Soci√©t√©"))
    urgency = st.selectbox("Degr√© d'urgence :", ("Normal", "Urgent"))
    question = st.text_area("Expliquez bri√®vement votre cas :", height=150)

    if st.button("Obtenir une estimation"):
        if question:
            try:
                with st.spinner("Analyse en cours..."):
                    domaine, prestation = analyze_question(question, client_type, urgency)
                    estimation_basse, estimation_haute, calcul_details, tarifs_utilises = calculate_estimate(domaine, prestation, urgency)
                    detailed_analysis, elements_used, sources = get_detailed_analysis(question, client_type, urgency, domaine, prestation)

                st.success("Analyse termin√©e. Voici les r√©sultats :")
                
                col1, col2 = st.columns(2)
                with col1:
                    st.subheader("R√©sum√© de l'estimation")
                    st.write(f"**Domaine juridique :** {domaine}")
                    st.write(f"**Prestation :** {prestation}")
                    st.write(f"**Estimation :** Entre {estimation_basse} ‚Ç¨HT et {estimation_haute} ‚Ç¨HT")
                    
                    st.subheader("D√©tails du calcul")
                    for detail in calcul_details:
                        st.write(detail)

                with col2:
                    st.subheader("√âl√©ments tarifaires utilis√©s")
                    st.json(tarifs_utilises)

                    if elements_used:
                        st.subheader("√âl√©ments sp√©cifiques pris en compte")
                        st.json(elements_used)

                st.subheader("Analyse d√©taill√©e")
                st.write(detailed_analysis)

                if sources:
                    st.subheader("Sources d'information")
                    st.write(sources)

                st.markdown("---")
                st.markdown("### üí° Alternative Recommand√©e")
                st.info("**Consultation initiale d'une heure** - Tarif fixe : 100 ‚Ç¨ HT")

            except Exception as e:
                st.error(f"Une erreur s'est produite : {str(e)}")
        else:
            st.warning("Veuillez d√©crire votre cas avant de demander une estimation.")

    st.markdown("---")
    st.write("¬© 2024 View Avocats. Tous droits r√©serv√©s.")

if __name__ == "__main__":
    main()
